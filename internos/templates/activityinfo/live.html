{% extends "base2.html" %}
{% load staticfiles i18n %}
{% load util_tags %}
{% load static %}
{% block content %}

<div class="app-main__inner">
  <div class="app-page-title">
      <div class="page-title-wrapper">
         <form action="{% url 'activityinfo:live_report' %}" method="get">
        <input type="hidden" name="ai_id" value="{{ database.ai_id }}"/>
        <div class="page-title-heading" data-step="4" data-intro="Filter options by partner or governorate">
          <div class="page-title-icon">
            <i class=" fa fa-rss icon-gradient bg-malibu-beach">
            </i>
          </div>
          <div>
            <div class="page-title-subheading">
            </div>
          </div>
              <select class="btn btn-outline-primary" multiple="multiple" id="filter_partners" name="partners">
            {% for partner in partners %}
            <option class="dropdown-item" value="{{ partner.partner_id }}" {% if partner.partner_id in selected_partners %}selected{% endif %}>{{ partner.partner_label }}
            </option>
            {% endfor %}
          </select>
          <select class="btn btn-outline-primary" multiple="multiple" id="filter_governorates" name="governorates">
            {% for gov in governorates %}
            <option class="dropdown-item" value="{{ gov.location_adminlevel_governorate_code }}" {% if gov.location_adminlevel_governorate_code in selected_governorates %}selected{% endif %}>
              {{ gov.location_adminlevel_governorate }}
            </option>
            {% endfor %}
          </select>
<!--          <button type="submit" class="btn btn-primary mr-left-5">Search</button>-->
<!--          <a href="{% url 'activityinfo:report' %}?ai_id={{ database.ai_id }}"-->
<!--             class="btn btn-light d-inline-block">Cancel</a>-->

           <button type="submit" class="btn btn shadow btn-primary mr-left-5" title="Search"><i style="font-weight:bolder" class="pe-7s-search"></i></button>
              <a href="{% url 'activityinfo:live_report' %}?ai_id={{ database.ai_id }}"title="Cancel"
                 class="btn btn-light d-inline-block"><i class="fa fa-fw" aria-hidden="true"></i></a>
        </div>
         </form>
           <div class="page-title-actions">
          <div class="d-inline-block" data-step="5"
               data-intro="If you need any assistance, here you can find the ActivityInfo database's focal point">
            <button type="button" data-toggle="tooltip" title="Database focal point: {{ database.focal_point }}
            <br />
            email: {{ database.focal_point.email }} " data-placement="bottom" data-html="true"
                    class="btn-shadow mr-3 btn btn-outline-primary">
              <i class="fa fa-user"></i>
            </button>

            <a class="btn shadow mr-3 btn-outline-dark"
               href="mailto:{{ database.focal_point.email }}?subject=ActivityInfo: Inquiry about {{ database.label }} database"
               data-toggle="tooltip" data-placement="bottom" title="Send email to the database focal point">
              <i class="fa fa-envelope"></i>
            </a>
            <a class="btn shadow mr-3 btn-outline-warning" href="javascript:void(0);"
               onclick="javascript:introJs().setOption('showProgress', true).start();" data-toggle="tooltip"
               data-placement="bottom" title="Show me some tips">
              <i class="fa fa-lightbulb" aria-hidden="true"></i>
            </a>
          </div>
        </div>
      </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <div class="main-card mb-3 card">
        <div class="card-body">
           <div class="text-danger fsize-1 mb-1 mt-2">
            <i class="fa fa-fw" aria-hidden="true" title=""></i>
          These numbers are only for monitoring purposes, don't use it in any official report.
       </div>
          <div class="card-title d-inline-block">

            <span data-step="6" data-intro="Collapse / Expand master indicators">
              <a href="#" class="collapse-all active"><i class="fa fa-th-large"></i></a>
              <a href="#" class="expanded-all"><i
                class="fa fa-bars"></i></a>
            </span>
             Live Dashboard - {{ database.label }} - {{database.reporting_year.year}}
            <div class="dropdown d-inline-block" data-intro="Download Dashboard report and raw data">
              <button type="button" aria-haspopup="true" aria-expanded="false" id="drop5" title="Download report"
                      data-toggle="dropdown" class="mb-2 mr-2 dropdown-toggle btn btn-link">
                <i class="fa fa-download"></i>
                <span class="caret"></span>
              </button>
              <div tabindex="-1" id="menu2" role="menu" aria-hidden="true" class="dropdown-menu" data-step="7">
                <button type="button" tabindex="0" id="export1" class="dropdown-item">Current dashboard</button>
                <div tabindex="-1" class="dropdown-divider"></div>
                <a type="button" tabindex="0" class="dropdown-item" style="text-transform: none;"
                   href="{% url 'activityinfo:export' %}?ai_id={{ database.ai_id }}&month={{ month }}&format=mapping_extraction3">
                 Raw Data
                </a>
                <div tabindex="-1" class="dropdown-divider"></div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="mb-0 table table-striped table-hover" id="exportheader"
                   content="{{ day_number }}_{{ month_number }}_{{ database.reporting_year.name }}_{{ database.label }} Dashboard - Live data.csv"
                   data-tableName="Dashboard - {{ database.label }} - {{ database.reporting_year.year }}">
              <thead>
              <tr>
                <th content="Indicator Name"> Indicator Name</th>
                <th content="RWP Code">RWP Code</th>
                <th content="Target">Target</th>
                <th content="As of today" data-toggle="tooltip" data-placement="top"
                    title="As of today (Starting January)">
                  As of today
                </th>
                <th content="Total Percentage achieved of all months" data-toggle="tooltip" data-placement="top"
                    title="Total Percentage achieved of all months">
                  Percentage Achieved <i class="fa fa-question-circle-o"></i>
                </th>
                <th content="Status">Status</th>
                <th content="{{ month_name }}">{{ month_name }}</th>
              </tr>
              </thead>
             <tbody>
                        {% for item in master_indicators %}
                          {% get_indicator_live_cumulative item month selected_partner selected_governorate as cumulative_value %}
                          {% to_display_indicator selected_filter cumulative_value as display_indicator %}

                          {% if display_indicator %}
                          <tr itemid="{{ item.id }}" {% if item.master_indicator %}class="level1 master_indicator"{% elif item.individual_indicator %}class="level1 individual_indicator"{% endif %}>
                              <!--<td>{{ item.id }}</td>-->
                              {% if item.master_indicator %}
                                <td  class="w-150">
                                  {{ item.name }}
                                  {% if item.explication %}
                                  <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item.explication }}"></i>
                                  {% endif %}
                                </td>
                              {% else %}

                                <td class="w-150">
                                  {{ item.name }}
                                  {% if item.explication %}
                                  <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item.explication }}"></i>
                                  {% endif %}
                                </td>
                              {% endif %}
                              <!--<td>Site</td>-->
                              <td class="w-10">{{ item.awp_code }}</td>
                              <td class="w-10">
                                {% if item.measurement_type == 'percentage' %}
                                  {{ item.target }}%
                                {% else %}
                                  {{ item.target|number_format }}
                                {% endif %}
                              </td>
                              <td class="w-10">
                                {{ cumulative_value }}
                              </td>
                              <td class="w-10">
                                {% get_indicator_live_achieved item month selected_partner selected_governorate as achieved %}
                                {{ achieved }}%
                              </td>
                              <td class="w-10" ><div class='badge {{ item.status_color }}'>{{ item.status }}</div></td>
                              <td class="w-10">
                                {% get_indicator_live_value item month selected_partner selected_governorate as value %}
                                {{ value }}
                              </td>
                          </tr>
                          {% get_sub_indicators_data item.id as sub_indicators %}
                          {% for item1 in sub_indicators %}
                            <tr class="level2 level2-{{ item.id }}" itemid="{{ item.id }}-{{ item1.id }}" {% if item1.master_indicator_sub %}style="background-color: #ca292940;"{% endif %}>
                                <!--<td>{{ item1.id }}</td>-->
                                {% if item1.master_indicator_sub %}
                                  <td  class="w-150">
                                    {{ item1.name }}
                                    {% if item1.explication %}
                                    <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item1.explication }}"></i>
                                    {% endif %}
                                  </td>
                                {% else %}
                                  <td class="w-150">
                                    {{ item1.name }}
                                    {% if item1.explication %}
                                    <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item1.explication }}"></i>
                                    {% endif %}
                                  </td>
                                {% endif %}
                                <!--<td>Site</td>-->
                                <td class="w-10">{{ item1.awp_code }}</td>
                                <td class="w-10">{{ item1.target|number_format }}</td>
                                <td class="w-10">
                                   {% get_indicator_live_cumulative item1 month selected_partner selected_governorate as cumulative_value %}
                                   {{ cumulative_value }}
                                </td>
                                <td class="w-10">
                                  {% get_indicator_live_achieved item1 month selected_partner selected_governorate as achieved %}
                                  {{ achieved }}%
                                </td>
                              <td class="w-10" ><div class='badge {{ item.status_color }}'>{{ item.status }}</div></td>
                                <td class="w-10">
                                    {% get_indicator_live_value item1 month selected_partner selected_governorate as value %}
                                    {{ value }}
                                </td>
                            </tr>
                            {% get_sub_indicators_data item1.id as sub_indicators1 %}
                            {% for item2 in sub_indicators1 %}
                              {% if item2.master_indicator == 0 and item2.master_indicator_sub == 0 %}
                              <tr class="level3 level3-{{ item.id }} level3-{{ item.id }}-{{ item1.id }}" itemid="{{ item.id }}-{{ item1.id }}-{{ item2.id }}">
                                  <!--<td>{{ item2.id }}</td>-->
                                  {% if item2.master_indicator_sub_sub %}
                                    <td class="w-150" >
                                      {{ item2.name }}
                                      {% if item2.explication %}
                                      <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item2.explication }}"></i>
                                      {% endif %}
                                    </td>
                                  {% else %}

                                    <td class="w-150">
                                      {{ item2.name }}
                                      {% if item2.explication %}
                                      <i class="fa fa-question-circle-o" style="font-size:16px;" data-toggle="tooltip" data-placement="top" title="{{ item2.explication }}"></i>
                                      {% endif %}
                                    </td>
                                  {% endif %}
                                  <!--<td>Site</td>-->
                                  <td class="w-10">{{ item2.awp_code }}</td>
                                  <td class="w-10">{{ item2.target|number_format }}</td>
                                  <td class="w-10">
                                     {% get_indicator_live_cumulative item2 month selected_partner selected_governorate as cumulative_value %}
                                     {{ cumulative_value }}
                                  </td>
                                  <td class="w-10">
                                    {% get_indicator_live_achieved item2 month selected_partner selected_governorate as achieved %}
                                    {{ achieved }}%
                                  </td>
                               <td class="w-10" ><div class='badge {{ item.status_color }}'>{{ item.status }}</div></td>
                                  <td class="w-10">
                                    {% get_indicator_live_value item2 month selected_partner selected_governorate as value %}
                                    {{ value }}
                                  </td>
                              </tr>
                              {% endif %}
                            {% endfor %}
                          {% endfor %}
                        {% endif %}
                        {% endfor %}
                      </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Partner Modal -->
    {% if partner_info %}
    <div id="partnerModal" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content" style="width: 800px !important;">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Partner Profile</h4>
          </div>
          <div class="modal-body" style="width: 800px !important;">
            <div class="row">
              <div class="col-md-12" style="font-size: 16px;">
                <i class="fa fa-user" style="color: #0089d2;"></i>
                <a href="https://etools.unicef.org/pmp/partners/{{ partner_info.etl_id }}/details" target="_blank">
                  {{ partner_info.name }} <i class="fa fa-external-link" style="font-size: 16px; color: #0089d2;"></i>
                </a>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12" style="font-size: 16px;">
                <i class="fa fa-tags" style="color: #0089d2;"></i>
                {{ partner_info.type }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-12" style="font-size: 16px;">
                <i class="fa fa-star-o" style="color: #0089d2;"></i>
                {{ partner_info.rating }}
              </div>
            </div>

            <div class="clearfix"></div>
            <br/>

            {% if partner_info.interventions %}
            <div class="row">
              <h5 class="modal-title">Interventions</h5>
            </div>
            <br/>
            {% endif %}
            {% for inter in partner_info.interventions %}
            <div class="row" style="padding-top: 5px; padding-bottom: 5px;">
              <div class="col-md-6">
                <i class="fa fa-file-text-o" style="font-size: 16px; color: #0089d2;"></i>
                <a href="https://etools.unicef.org/pmp/interventions/{{ inter.etl_id }}/details" target="_blank">
                  {{ inter.number }}
                  <i class="fa fa-external-link" style="font-size: 16px; color: #0089d2;"></i>
                </a>
              </div>
              <div class="col-md-2">
                <i class="fa fa-calendar" style="font-size: 16px; color: #0089d2;"></i> {{ inter.start }}
              </div>
              <div class="col-md-2">
                <i class="fa fa-calendar" style="font-size: 16px; color: #0089d2;"></i> {{ inter.end }}
              </div>
            </div>

            <div class="row" style="padding-top: 5px; padding-bottom: 5px;">
              <div class="col-md-6">
                <i class="fa fa-map-o" style="font-size: 16px; color: #0089d2;"></i>
                {% for p_code in inter.location_p_codes %}
                {{ p_code }}
                {% endfor %}
              </div>
              <div class="col-md-4">
                <i class="fa fa-usd" style="font-size: 16px; color: #0089d2;"></i>
                {{ inter.total_budget }} {{ inter.budget_currency }}
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'vendors/jquery-quicksearch/jquery.quicksearch.js' %}"></script>
<script src="//cdn.rawgit.com/rainabba/jquery-table2excel/1.1.0/dist/jquery.table2excel.min.js"></script>
<script src="{% static 'js/bootstrap-multiselect.min.js' %}"></script>
<script src="{% static 'vendors/tableexport/xlsx.core.js' %}"></script>
<script src="{% static 'vendors/tableexport/FileSaver.js' %}"></script>
<script src="{% static 'vendors/tableexport/tableexport.js' %}"></script>
<script>

  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
};
  $(document).ready(function () {

    var id = getUrlParameter('ai_id');
    var selected_li=$('li#'+id).find('a');
    var parent = selected_li.parent();
    parent.addClass("mm-active");
    selected_li.addClass("mm-active");



  $('.level1').addClass('collapsed');
      $('.level2').addClass('collapsed');
      $('.level3').addClass('collapsed');

      $('.level2').hide();
      $('.level3').hide();



    $('.expanded-all').click(function(){
        $('.expanded-all').addClass('active');
        $('.collapse-all').removeClass('active');

        $('.level1').removeClass('collapsed');
        $('.level2').removeClass('collapsed');
        $('.level3').removeClass('collapsed');

        $('.level1').show();
        $('.level2').show();
        $('.level3').show();
    });

    $('.collapse-all').click(function(){
        $('.expanded-all').removeClass('active');
        $('.collapse-all').addClass('active');

        $('.level1').addClass('collapsed');
        $('.level2').addClass('collapsed');
        $('.level3').addClass('collapsed');

        $('.level2').hide();
        $('.level3').hide();
    });

    $('.level1').dblclick(function(){
      var itemid = $(this).attr('itemid');
      var sub_items = 'tr.level2-'+itemid;
      var sub_sub_items = 'tr.level3-'+itemid;

      if($(this).hasClass('collapsed')){
          $(sub_items).show();
          $(this).removeClass('collapsed');
      }else{
          $(sub_items).hide();
          $(sub_items).addClass('collapsed');
          $(sub_sub_items).hide();
          $(this).addClass('collapsed');
      }
    });

    $('.level2').dblclick(function(){
      var itemid = $(this).attr('itemid');
      var sub_items = 'tr.level3-'+itemid;

      if($(this).hasClass('collapsed')){
          $(sub_items).show();
          $(this).removeClass('collapsed');
      }else{
          $(sub_items).hide();
          $(this).addClass('collapsed');
      }
    });
});


function download_csv(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV FILE
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // We have to create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Make sure that the link is not displayed
    downloadLink.style.display = "none";

    // Add the link to your DOM
    document.body.appendChild(downloadLink);

    // Lanzamos
    downloadLink.click();
}

function export_table_to_csv(html, filename) {
	var csv = [];
	 $("tr:hidden,td:hidden","#exportheader").remove();
	var rows_header = document.querySelectorAll("table#exportheader thead tr");
	var rows = document.querySelectorAll("table#exportheader tbody tr");

    for (var i = 0; i < rows_header.length; i++) {
		var row = [], cols = rows_header[i].querySelectorAll("th");

        for (var j = 0; j < cols.length; j++)
            row.push($(cols[j]).attr('content'));

    csv.push(row.join(","));
	}

  for (var i = 0; i < rows.length; i++) {
		var row = [], cols = rows[i].querySelectorAll("td, th");

        for (var j = 0; j < cols.length; j++) {
            if($(cols[j]).attr('colspan') == '2') {
              row.push('');
            }
            row.push(cols[j].innerText);
        }

		csv.push(row.join(","));
	}

    // Download CSV
    download_csv(csv.join("\n"), filename);
}

document.querySelector("#export1").addEventListener("click", function () {
    var html = document.querySelector("table").outerHTML;
    var file_name = $("#exportheader").attr("content");
	  export_table_to_csv(html, file_name);
});

function search() {
  $('input#search-input').quicksearch('table#exportheader tbody tr', {
    'delay': 300,
    'selector': 'td',
    'stripeRows': ['odd', 'even'],
    'loader': 'span.loading',
    'bind': 'keyup click input',
    'prepareQuery': function (val) {
    return new RegExp(val, "i");
  },
    'testQuery': function (query, txt, _row) {
      return query.test(txt);
    }
});
}

  $('#close-search').click(function(e) {
  $("#searchdiv").triggerHandler("focus");
      $('input#search-input').val('').focus();
      search();
       $('.level1').addClass('collapsed');
      $('.level2').addClass('collapsed');
      $('.level3').addClass('collapsed');

      $('.level2').hide();
      $('.level3').hide();
  });

 $('#filter_partners').multiselect({
    buttonWidth : '180px',
    includeSelectAllOption : true,
		nonSelectedText: 'Partners',
		nSelectedText:'selected partners'
  });
 $('#filter_governorates').multiselect({
    buttonWidth : '200px',
    includeSelectAllOption : true,
		nonSelectedText: 'Governorates',
		nSelectedText:'selected governorates'
  });



</script>

{% endblock %}
